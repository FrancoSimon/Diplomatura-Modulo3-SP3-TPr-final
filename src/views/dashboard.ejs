<section class="text-center mb-10">
  <h1 class="inline-block text-4xl font-extrabold bg-gray-700 text-white px-4 py-2 rounded drop-shadow-lg">
    Listado de Países Hispanohablantes
  </h1>
</section>


<main class="flex justify-center px-4 py-10">
  <div class="w-full max-w-7xl">
    <div class="overflow-x-auto rounded-xl shadow-lg">
      <table class="min-w-full border border-gray-300 bg-white bg-opacity-90">
        <thead class="bg-gray-800 text-white">
          <tr>
            <th class="px-4 py-2 text-left">Nombre</th>
            <th class="px-4 py-2 text-left">Capital</th>
            <th class="px-4 py-2 text-left">Fronteras</th>
            <th class="px-4 py-2 text-left">Área (km²)</th>
            <th class="px-4 py-2 text-left">Población</th>
            <th class="px-4 py-2 text-left">Gini</th>
            <th class="px-4 py-2 text-left">Zonas Horarias</th>
            <th class="px-4 py-2 text-left">Creador</th>
            <th class="px-4 py-2 text-center">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <% 
            let totalPoblacion = 0;
            let totalArea = 0;
            let totalGini = 0;
            let countGini = 0;
          %>
          <% paises.forEach(pais => { 
              totalPoblacion += pais.poblacion || 0;
              totalArea += pais.area || 0;

              // gini: tomar promedio del mapa si existe
              let giniValor = null;
              if (pais.gini && Object.keys(pais.gini).length > 0) {
                const valores = Object.values(pais.gini);
                giniValor = valores.reduce((a,b)=>a+b,0) / valores.length;
                totalGini += giniValor;
                countGini++;
              }
          %>
            <tr class="border-b hover:bg-gray-100">
              <td class="px-4 py-2 font-semibold">
                <%= pais.nombre || pais.nombreOficial %>
              </td>
              <td class="px-4 py-2">
                <%= pais.capital && pais.capital.length ? pais.capital.join(', ') : '—' %>
              </td>
              <td class="px-4 py-2">
                <%= pais.fronteras && pais.fronteras.length ? pais.fronteras.join(', ') : '—' %>
              </td>
              <td class="px-4 py-2"><%= pais.area.toLocaleString() %></td>
              <td class="px-4 py-2"><%= pais.poblacion.toLocaleString() %></td>
              <td class="px-4 py-2"><%= giniValor ? giniValor.toFixed(1) : '—' %></td>
              <td class="px-4 py-2">
                <%= pais.zonaHoraria && pais.zonaHoraria.length ? pais.zonaHoraria.join(', ') : '—' %>
              </td>
              <td class="px-4 py-2"><%= pais.creador %></td>

              <td class="px-4 py-2">
                  <div class="flex justify-center gap-2">
                    <a href="/api/paises/<%= pais._id %>"
                        class="inline-flex items-center px-3 py-1.5 rounded-lg text-sm font-semibold bg-blue-600 text-white hover:bg-blue-700 transition">
                        Ver
                    </a>
                    <a href="/api/paises/<%= pais._id %>/editar"
                        class="inline-flex items-center px-3 py-1.5 rounded-lg text-sm font-semibold bg-yellow-500 text-white hover:bg-yellow-600 transition">
                        Editar
                    </a>
                    <form id="form-<%= pais._id %>" action="/api/paises/<%= pais._id %>?_method=DELETE" method="POST">
                    <button type="button"
                            onclick="confirmarEliminacion('<%= pais._id %>')"
                          class="inline-flex items-center px-3 py-1.5 rounded-lg text-sm font-semibold bg-red-600 text-white hover:bg-red-700 transition">
                          Eliminar
                      </button>
                    </form>
                  </div>
                </td>


            </tr>
          <% }) %>

          <!-- Fila de totales -->
          <tr class="bg-gray-200 font-bold">
            <td colspan="3" class="px-4 py-2 text-right">Totales:</td>
            <td class="px-4 py-2"><%= totalArea.toLocaleString() %></td>
            <td class="px-4 py-2"><%= totalPoblacion.toLocaleString() %></td>
            <td class="px-4 py-2"><%= countGini > 0 ? (totalGini / countGini).toFixed(1) : '—' %></td>
            <td colspan="3"></td>
          </tr>
        </tbody>
      </table>
    </div>
   
<!-- Nota explicativa -->
<p class="mt-4 text-center text-sm text-gray-500 italic">
  Totales: <%= totalArea.toLocaleString() %> km² (Área total) — 
  <%= totalPoblacion.toLocaleString() %> (Población total) — 
  <%= countGini > 0 ? (totalGini / countGini).toFixed(1) : '—' %> (Gini promedio)
</p>
  </div>
</main>

<!-- Importar SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  function confirmarEliminacion(paisId) {
    Swal.fire({
      title: '¿Estás seguro?',
      text: 'Esta acción eliminará permanentemente al País.',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: 'Sí, eliminar',
      cancelButtonText: 'Cancelar',
      confirmButtonColor: '#d33',
      cancelButtonColor: '#3085d6',
      customClass: {
        popup: 'max-w-md w-full rounded-xl shadow-xl px-4',
        title: 'text-base md:text-xl font-bold',
        htmlContainer: 'text-sm md:text-base',
        confirmButton: 'w-full md:w-auto text-white bg-red-600 hover:bg-red-700 px-6 py-2 rounded-xl mb-2 md:mb-0 md:mr-2',
        cancelButton: 'w-full md:w-auto text-black border border-black hover:bg-gray-200 px-6 py-2 rounded-xl mt-2 md:mt-0'
      },
      buttonsStyling: false
    }).then((result) => {
      if (result.isConfirmed) {
        document.getElementById('form-' + paisId).submit();
      }
    });
  }
</script>
<!--mostrar el SweetAlert de éxito creado pais solo si viene success=1 en la URL:-->
<script>
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get("success") === "1") {
    Swal.fire({
      title: 'País creado',
      text: 'El país ha sido guardado exitosamente.',
      icon: 'success',
      background: '#f9fafb',
      color: '#1f2937',
      iconColor: '#10b981',
      showConfirmButton: false,
      timer: 2000,
      timerProgressBar: true,
      customClass: {
        popup: 'max-w-md w-full rounded-xl shadow-xl px-4',
        title: 'text-base md:text-xl font-bold',
        htmlContainer: 'text-sm md:text-base',
      }
    });
  }
</script>